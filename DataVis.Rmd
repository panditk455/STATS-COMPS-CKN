---
title: "Polygonal vs Non-Polygonal and KQ vs QQ quality views"
output: html_document
---

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(ggplot2)
library(scales)
```

Importing the Data

```{r}
file_path <- "data/bullets_2024.xlsx"

kq_data <- read_excel(file_path, sheet = "KQ responses (n=1575)")
qq_data <- read_excel(file_path, sheet = "QQ responses (n=1581)")
cset_data <- read_excel(file_path, sheet = "Cset (n=1240)")
```

Data Cleaning

```{r}
phase_label <- "Primary (Baseline)"

kq <- kq_data %>%
  filter(Phase == phase_label) %>%
  mutate(
    Decision = if_else(K01_Q1value == "NoValue", "NoValue", K08_Conclusion),
    Comparison = "KQ"
  ) %>%
  select(AnonID, Cset, Mating, Decision, Comparison)

qq <- qq_data %>%
  filter(Phase == phase_label) %>%
  mutate(
    Decision = if_else(Q01_Q1value == "NoValue" | Q02_Q2value == "NoValue", "NoValue", Q08_Conclusion),
    Comparison = "QQ"
  ) %>%
  select(AnonID, Cset, Mating, Decision, Comparison)

cset <- cset_data %>%select( Cset, Type,`Cset Category (Detailed)`, `Cset Quality (voted)` ) %>%
  rename(Category = `Cset Category (Detailed)`, CsetQuality = `Cset Quality (voted)` )

responses <- bind_rows(kq, qq) %>%
  left_join(cset, by = "Cset") %>%
  mutate(Category = str_squish(Category), Decision = factor(Decision, levels = c("ID", "LeanID", "Insuff", "NoValue", "LeanExcl", "Excl")))
```

Polygonal vs non-polygonal  (Fig. 4)

```{r}
polygonal_data <- responses %>%
  filter(
    Type == "KQ",
    CsetQuality == "A:A",
    str_detect(Category, "Same Model"),
    str_detect(Category, "FMJ")
  ) %>%
  mutate(Rifling = if_else(str_detect(Category, "Polygonal"), "Polygonal", "Non-Polygonal"))

plot_polygonal <- polygonal_data %>%
  count(Mating, Rifling, Decision, name = "n") %>%
  group_by(Mating, Rifling) %>%
  mutate(pct = n / sum(n), label = if_else(pct > 0, percent(pct, accuracy = 1), "")) %>%
  ungroup()

totals <- polygonal_data %>%
  count(Mating, Rifling, name = "total")

ggplot(plot_polygonal, aes(x = Rifling, y = pct, fill = Decision)) +
  geom_col() +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 3) +
  geom_text(
    data = totals,
    aes(x = Rifling, y = -0.05, label = total),
    inherit.aes = FALSE,
    size = 3.2
  ) +
  facet_wrap(~ Mating, nrow = 1) +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Distribution of decisions for non-PR and PR KQsets",
    x = NULL,
    y = "% of responses",
    fill = NULL
  ) 
```

KQ vs QQ decision rates by quality (heatmap)

```{r}
quality_data <- responses %>%
  filter(!str_detect(Category, "Polygonal"), !str_detect(Category, "FMJ-JHP|JHP-FMJ"), !str_detect(Category, "Diff Caliber") ) %>% filter(!is.na(CsetQuality))

plot_quality <- quality_data %>%
  count(Mating, Comparison, CsetQuality, Decision, name = "n") %>%
  group_by(Mating, Comparison, CsetQuality) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup()

ggplot(plot_quality, aes(x = CsetQuality, y = Decision, fill = pct)) +
  geom_tile(color = "white") +
  geom_text(aes(label = percent(pct, accuracy = 0.1)), size = 2.6) +
  facet_grid(Mating ~ Comparison) +
  scale_fill_gradient(low = "white", high = "darkblue", labels = percent) +
  labs( title = "Decision distribution by quality (KQ vs QQ)",
    x = "Quality",
    y = NULL, fill = "% of responses"
  ) 
```





